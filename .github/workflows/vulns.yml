name: Dependabot Alerts â†’ Copilot Agent
on:
  schedule:
    - cron: '*/20 * * * *'
  workflow_dispatch:

jobs:
  assign-to-copilot:
    runs-on: ubuntu-latest
    permissions:
      issues: write

    steps:
      - name: Fetch and process new alerts
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT_SECURITY_EVENTS }}
          script: |
            const alerts = await github.rest.dependabot.listAlertsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              severity: 'high,critical'
            });

            console.log('Total open alerts:', alerts.data.length);
            console.log('Alerts:', JSON.stringify(alerts.data, null, 2));

            for (const alert of alerts.data) {
              const existingIssues = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                labels: 'dependabot',
                state: 'open'
              });

              const alreadyExists = existingIssues.data.some(i =>
                i.title.includes(`#${alert.number}`)
              );

              if (alreadyExists) {
                console.log(`Issue already exists for alert #${alert.number}, skipping`);
                continue;
              }

              console.log(`Creating issue for alert #${alert.number}:`, alert.security_advisory.summary);

              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `[Security] Dependabot alert #${alert.number}: ${alert.security_advisory.summary}`,
                body: `
            ## Dependabot Security Alert

            \`\`\`json
            ${JSON.stringify(alert, null, 2)}
            \`\`\`

            ## Task

            Analyze the alert above and fix the vulnerability.
            - Update the affected dependency to the patched version if available.
            - If no patch exists, evaluate mitigations or alternatives.
            - Run the existing tests to confirm nothing breaks.
            - Advisory references: ${alert.security_advisory.references?.map(r => r.url).join(', ') ?? 'N/A'}
                `,
                labels: ['security', 'dependabot', alert.security_advisory.severity],
                assignees: ['copilot']
              });

              console.log(`Issue created for alert #${alert.number}:`, issue.data.html_url);
            }