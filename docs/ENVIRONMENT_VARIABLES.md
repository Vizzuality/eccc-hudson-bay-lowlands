# Environment Variables

Single source of truth for all environment variables used across the project.

## Overview

Environment variables flow differently depending on the context:

```
Local development:  .env file --> docker-compose.yml --> containers
CI/CD:              GitHub Secrets/Vars --> workflow --> .env file --> Beanstalk deploy bundle
Production:         .env in deploy bundle --> docker-compose.prod.yml --> containers
```

- **Local**: Docker Compose reads the root `.env` file and passes variables to containers via the `environment` block.
- **CI/CD**: The deploy workflow assembles a `.env` file from GitHub Secrets and Variables, then bundles it into the Beanstalk deployment package.
- **Production**: Beanstalk uses `docker-compose.prod.yml` which substitutes `${VAR}` placeholders from the bundled `.env`.

## Local Development Variables

Copy `.env.example` to `.env` at the project root. These variables configure all local services.

### Database

| Variable | Required | Default | Description |
|----------|----------|---------|-------------|
| `DB_HOST` | Yes | `localhost` | PostgreSQL hostname. Use `eccc-db` inside Docker Compose, `localhost` for local dev. |
| `DB_PORT` | No | `5432` | PostgreSQL port |
| `DB_USERNAME` | No | `eccc` | PostgreSQL username |
| `DB_PASSWORD` | Yes | `eccc` | PostgreSQL password. Change in production. |
| `DB_NAME` | No | `eccc_db` | Primary database name |
| `TESTING` | No | `false` | When `true`, the API uses `eccc_db_test` database instead of `DB_NAME` |

### API

| Variable | Required | Default | Description |
|----------|----------|---------|-------------|
| `S3_BUCKET_NAME` | No | `""` | S3 bucket for application file storage |
| `SEED_SECRET` | **Yes** | *(none)* | Secret token for authorizing database seed requests via `POST /seed`. The API will crash on startup if this is not set. |
| `ROOT_PATH` | No | `""` | FastAPI root path for reverse proxy. Set to `/api` in production. |

### Client (build-time)

These variables are prefixed with `NEXT_PUBLIC_` and are embedded into the client JavaScript bundle at build time. Changing them requires a rebuild.

| Variable | Required | Default | Description |
|----------|----------|---------|-------------|
| `NEXT_PUBLIC_API_URL` | Yes | `http://localhost:8000` | API base URL used by the client |
| `NEXT_PUBLIC_MAPBOX_API_TOKEN` | No | `""` | Mapbox GL JS API token for map rendering |

### Client (runtime, server-side only)

These are available only on the server side at runtime. They are not exposed to the browser.

| Variable | Required | Default | Description |
|----------|----------|---------|-------------|
| `NEXTAUTH_URL` | No | `http://localhost:3000` | Base URL for NextAuth.js callbacks |
| `NEXTAUTH_SECRET` | No | `dev-secret-change-in-production` | Secret for signing NextAuth.js tokens |

## CI/CD Secrets and Variables

Configured in GitHub repository settings under Settings > Secrets and variables > Actions.

### Secrets (sensitive, encrypted)

| Secret | Description | Used by |
|--------|-------------|---------|
| `PIPELINE_USER_ACCESS_KEY_ID` | AWS IAM access key for CI/CD user | All deploy jobs |
| `PIPELINE_USER_SECRET_ACCESS_KEY` | AWS IAM secret key for CI/CD user | All deploy jobs |
| `AWS_REGION` | AWS region (e.g., `eu-north-1`) | All deploy jobs |
| `CLIENT_REPOSITORY_NAME` | ECR repository name for client image | Build/deploy |
| `API_REPOSITORY_NAME` | ECR repository name for API image | Build/deploy |
| `PROJECT_NAME` | Project name for Beanstalk app/env naming | Deploy |
| `DB_HOST` | Production RDS database hostname | Deploy |
| `DB_PORT` | Production database port | Deploy |
| `DB_NAME` | Production database name | Deploy |
| `DB_USERNAME` | Production database username | Deploy |
| `DB_PASSWORD` | Production database password | Deploy |
| `S3_BUCKET_NAME` | Production S3 bucket name | Deploy |
| `SEED_SECRET` | Secret token for authorizing `POST /seed` requests | Deploy |
| `NEXTAUTH_SECRET` | Production NextAuth.js secret | Deploy |

### Variables (non-sensitive)

| Variable | Description | Used by |
|----------|-------------|---------|
| `NEXT_PUBLIC_API_URL` | Production API URL (embedded at client build time) | Client build |
| `NEXT_PUBLIC_MAPBOX_API_TOKEN` | Production Mapbox token (embedded at client build time) | Client build |
| `NEXTAUTH_URL` | Production NextAuth.js URL | Deploy |

## Production Runtime Variables

These are set in the deploy bundle `.env` and consumed by `docker-compose.prod.yml`:

| Variable | Service | Description |
|----------|---------|-------------|
| `ECR_REGISTRY` | client, api | ECR registry URL (auto-generated by workflow) |
| `ECR_REPOSITORY_CLIENT` | client | ECR repository name for client image |
| `ECR_REPOSITORY_API` | api | ECR repository name for API image |
| `IMAGE_TAG` | client, api | Docker image tag (default: `dev`) |
| `DB_HOST` | api | RDS database hostname |
| `DB_PORT` | api | Database port |
| `DB_NAME` | api | Database name |
| `DB_USERNAME` | api | Database username |
| `DB_PASSWORD` | api | Database password |
| `S3_BUCKET_NAME` | api | S3 bucket name |
| `SEED_SECRET` | api | Secret token for authorizing `POST /seed` requests |
| `ROOT_PATH` | api | Always `/api` in production (set in compose file) |
| `NEXTAUTH_URL` | client | Production URL for NextAuth.js |
| `NEXTAUTH_SECRET` | client | NextAuth.js signing secret |

## Build-time vs Runtime

**Build-time** (`NEXT_PUBLIC_*`): Baked into the Next.js client bundle during `next build`. Visible to browsers. Changing these requires a new image build and deployment.

**Runtime**: Read by services at startup. Can be changed by updating the `.env` and restarting containers without rebuilding images. The API reads all its configuration at runtime. Client server-side variables (e.g., `NEXTAUTH_SECRET`) are also runtime.

## Adding a New Variable

Checklist when adding a new environment variable:

1. Add to the root `.env.example` with a comment and sensible default
2. If API-specific, add to `api/config.py` in the `Settings` class with a `Field(validation_alias="VAR_NAME")`
3. If needed in Docker, add to the appropriate service in `docker-compose.yml`
4. If needed in production, add to `infrastructure/source_bundle/docker-compose.prod.yml`
5. If needed in CI/CD deployment, add to the `deploy` job in `.github/workflows/deploy-trunk.yml`
6. If it is a secret, add to GitHub repository Secrets; if non-sensitive, add to Variables
7. Update this document (`docs/ENVIRONMENT_VARIABLES.md`)
